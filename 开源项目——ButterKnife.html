<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="那些年，那些牛B的开源项目," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/avatar.jpeg?v=5.1.0" />






<meta name="description" content="前言从 ButterKnife 开始，我会不定时研究常用Android开源项目，梳理它们各自的原理，并沉淀为技术文章，敬请期待。">
<meta property="og:type" content="article">
<meta property="og:title" content="开源项目——ButterKnife">
<meta property="og:url" content="http://zhanghao.studio/开源项目——ButterKnife.html">
<meta property="og:site_name" content="My World">
<meta property="og:description" content="前言从 ButterKnife 开始，我会不定时研究常用Android开源项目，梳理它们各自的原理，并沉淀为技术文章，敬请期待。">
<meta property="og:updated_time" content="2017-12-24T13:15:00.656Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开源项目——ButterKnife">
<meta name="twitter:description" content="前言从 ButterKnife 开始，我会不定时研究常用Android开源项目，梳理它们各自的原理，并沉淀为技术文章，敬请期待。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhanghao.studio/开源项目——ButterKnife.html"/>





  <title> 开源项目——ButterKnife | My World </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  









<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500436045");

  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>






  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Talk is cheap,show me your code!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heart"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanghao.studio/开源项目——ButterKnife.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张昊">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1487524748815&di=cd0f9aa211a9dd59ef60da71ac98b364&imgtype=0&src=http%3A%2F%2Fp8.qhimg.com%2Ft01b3499a7704e3ea91.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                开源项目——ButterKnife
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-09T00:20:45+08:00">
                2017-11-09
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-12-24T21:15:00+08:00">
                2017-12-24
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,456 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  16 min
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>从 ButterKnife 开始，我会不定时研究常用Android开源项目，梳理它们各自的原理，并沉淀为技术文章，敬请期待。</p>
<a id="more"></a>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h4><p>ButterKnife 提供了很多<strong>自定义注解</strong>，最常用的就是 @BindView 和 @OnClick， 然后由<strong>自定义APT（注解处理器）</strong>在编译时生成绑定 View 和点击事件的代码。在获取类 xxx_ViewBinding 的对象时，借助了  <strong>Java 反射</strong>。</p>
<h4 id="源码跟踪"><a href="#源码跟踪" class="headerlink" title="源码跟踪"></a>源码跟踪</h4><p>我阅读的是 8.2.1 版本的源码，它的使用不具体介绍了，不同的版本，注解名可能会有变动，建议直接看 GitHub 上的 <a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="external">ReadMe</a> 。</p>
<p>在某个要使用 ButterKnife 的 activity 中，我们需要在 OnCreate() 方法中添加代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ButterKnife.bind(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p>进入 bind(this) 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">   View sourceView = target.getWindow().getDecorView();</div><div class="line">   <span class="keyword">return</span> createBinding(target, sourceView);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getDecorView() 获取到 window 中的最顶层 View，然后传入 createBinding ();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</div><div class="line">    Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</div><div class="line">    <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> Unbinder.EMPTY;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> constructor.newInstance(target, source);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  <span class="comment">//······省略部分 try/catch 代码</span></div><div class="line">  </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>首先获取到该 activity 的 Class 对象，将其传入 findBindingConstructorForClass():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</div><div class="line">  Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</div><div class="line">  <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in binding map."</span>);</div><div class="line">    <span class="keyword">return</span> bindingCtor;</div><div class="line">  &#125;</div><div class="line">  String clsName = cls.getName();</div><div class="line">  <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + <span class="string">"_ViewBinding"</span>);</div><div class="line">    <span class="comment">//noinspection unchecked</span></div><div class="line">    bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded binding class and constructor."</span>);</div><div class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</div><div class="line">    bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</div><div class="line">  &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</div><div class="line">  &#125;</div><div class="line">  BINDINGS.put(cls, bindingCtor);</div><div class="line">  <span class="keyword">return</span> bindingCtor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BINDERS 是一个 LinkedHashMap ,用来缓存 clsName_ViewBinding 的构造器对象，避免下次调用继续使用反射影响性能。若缓存中没有，通过 Class 的 getClassLoader() 加载该类，然后用反射得到构造器对象，并放入 map。</p>
<p>然后调用 newInstance() 生成 clsName_ViewBinding 的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity_ViewBinding</span> <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> MainActivity target;</div><div class="line">  <span class="keyword">private</span> View view2131427422;</div><div class="line"></div><div class="line">  <span class="comment">//······略</span></div><div class="line"></div><div class="line">  <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> MainActivity target, View source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    view = Utils.findRequiredView(source, R.id.text, <span class="string">"field 'textView' and method 'onViewClicked'"</span>);</div><div class="line">    target.textView = Utils.castView(view, R.id.text, <span class="string">"field 'textView'"</span>, TextView.class);</div><div class="line">    view2131427422 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.onViewClicked(p0);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="meta">@CallSuper</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</div><div class="line">    MainActivity target = <span class="keyword">this</span>.target;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</div><div class="line">    <span class="comment">//解绑时释放持有的引用（view 和点击事件）</span></div><div class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</div><div class="line">    target.textView = <span class="keyword">null</span>;</div><div class="line">    view2131427422.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    view2131427422 = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构造方法里的 Utils.findRequiredView 调用了 View 的 findViewById() 实现对 view 的绑定，并强制转换为声明的类型。需要注意的是，<strong>因为通过 target.xxx 来赋值，所以我们不能将 View 定义为 private 的</strong>。变量 view2131427422 是为了解绑时释放对 OnClickListener 的引用，所以该变量的数目取决于 @OnClick 中 View Id 的数目。</p>
<p>看到这里，我们对 ButterKnife 的核心流程有个大致了解了。但你肯定很好奇，xxx_ViewBinding 是怎么生成的？这就是 APT（注解处理器） 干的活啦。</p>
<h4 id="APT-和-ButterKnifeProcessor"><a href="#APT-和-ButterKnifeProcessor" class="headerlink" title="APT 和 ButterKnifeProcessor"></a>APT 和 ButterKnifeProcessor</h4><blockquote>
<p>APT(Annotation Processing Tools) 的原理是在某些代码元素上（如类型、函数、字段等）添加注解，在编译时编译器会检查 AbstractProcessor 的子类，并且调用该类型的 process 函数，然后将添加了注解的所有元素都传递到 process 函数中，使得开发人员可以在编译器进行相应的处理，例如，根据注解生成新的Java类，这也就是EventBus，Retrofit，Dragger等开源库的基本原理。 </p>
</blockquote>
<h5 id="init-ProcessingEnvironment-env"><a href="#init-ProcessingEnvironment-env" class="headerlink" title="init(ProcessingEnvironment env)"></a>init(ProcessingEnvironment env)</h5><p>我们先来看看 <code>ButterKnifeProcessor</code> 中的 <code>init(ProcessingEnvironment env)</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.init(env);</div><div class="line">	String sdk = env.getOptions().get(OPTION_SDK_INT);</div><div class="line">	<span class="keyword">if</span> (sdk != <span class="keyword">null</span>) &#123;</div><div class="line">	  <span class="keyword">try</span> &#123;</div><div class="line">	    <span class="keyword">this</span>.sdk = Integer.parseInt(sdk);</div><div class="line">	  &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">	    env.getMessager()</div><div class="line">	        .printMessage(Kind.WARNING, <span class="string">"Unable to parse supplied minSdk option '"</span></div><div class="line">	            + sdk</div><div class="line">	            + <span class="string">"'. Falling back to API 1 support."</span>);</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 得到一些有用的工具类</span></div><div class="line">	elementUtils = env.getElementUtils();</div><div class="line">	typeUtils = env.getTypeUtils();</div><div class="line">	filer = env.getFiler();</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">	  trees = Trees.instance(processingEnv);</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException ignored) &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>init</code> 中主要根据 <code>env</code> 得到一些工具类。其中的 <code>filter</code> 主要是用来生成 Java 代码，而 <code>elementUtils</code> 和 <code>typeUtils</code> 会在下面源码中用到。</p>
<h5 id="getSupportedAnnotationTypes"><a href="#getSupportedAnnotationTypes" class="headerlink" title="getSupportedAnnotationTypes()"></a>getSupportedAnnotationTypes()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Annotation&gt;&gt; LISTENERS = Arrays.asList(</div><div class="line">	OnCheckedChanged.class,</div><div class="line">	OnClick.class,</div><div class="line">	OnEditorAction.class,</div><div class="line">	OnFocusChange.class,</div><div class="line">	OnItemClick.class,</div><div class="line">	OnItemLongClick.class,</div><div class="line">	OnItemSelected.class,</div><div class="line">	OnLongClick.class,</div><div class="line">	OnPageChange.class,</div><div class="line">	OnTextChanged.class,</div><div class="line">	OnTouch.class</div><div class="line">);</div><div class="line"></div><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 返回注解处理器支持处理的注解</span></div><div class="line">	Set&lt;String&gt; types = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">	<span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</div><div class="line">	  types.add(annotation.getCanonicalName());</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> types;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 得到所有的注解</span></div><div class="line"><span class="keyword">private</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() &#123;</div><div class="line">	Set&lt;Class&lt;? extends Annotation&gt;&gt; annotations = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">	</div><div class="line">	annotations.add(BindArray.class);</div><div class="line">	annotations.add(BindBitmap.class);</div><div class="line">	annotations.add(BindBool.class);</div><div class="line">	annotations.add(BindColor.class);</div><div class="line">	annotations.add(BindDimen.class);</div><div class="line">	annotations.add(BindDrawable.class);</div><div class="line">	annotations.add(BindFloat.class);</div><div class="line">	annotations.add(BindInt.class);</div><div class="line">	annotations.add(BindString.class);</div><div class="line">	annotations.add(BindView.class);</div><div class="line">	annotations.add(BindViews.class);</div><div class="line">	annotations.addAll(LISTENERS);</div><div class="line">	<span class="keyword">return</span> annotations;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getSupportedAnnotationTypes()</code> 方法的作用就是返回该注解处理器所支持处理的注解集合。</p>
<h5 id="process-Set-lt-extends-TypeElement-gt-elements-RoundEnvironment-env"><a href="#process-Set-lt-extends-TypeElement-gt-elements-RoundEnvironment-env" class="headerlink" title="process(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)"></a>process(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</h5><p>这是注解处理器中最重要的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@Override </div><div class="line">public boolean process(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env) &#123;</div><div class="line">	// 扫描所有注解，最后生成 map</div><div class="line">	Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</div><div class="line">	// 遍历 bindingMap 并且通过 Filer 生成 Java 代码</div><div class="line">	for (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">	  TypeElement typeElement = entry.getKey();</div><div class="line">	  BindingSet binding = entry.getValue();</div><div class="line">	  JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">	  try &#123;</div><div class="line">	    javaFile.writeTo(filer);</div><div class="line">	  &#125; catch (IOException e) &#123;</div><div class="line">	    error(typeElement, &quot;Unable to write binding for type %s: %s&quot;, typeElement, e.getMessage());</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">	return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>process</code> 方法干了两个活：</p>
<ol>
<li>扫描所有的注解，然后生成以 <code>TypeElement</code> 为 key ，<code>BindingSet</code> 为 value 的 Map ；</li>
<li>遍历生成的 Map，通过 Filter 来生成对应的辅助类源码，这里使用了 <a href="https://github.com/square/javapoet" target="_blank" rel="external">JavaPoet</a> 来生成 Java 源码，可以阅读这篇文章 <a href="http://www.jianshu.com/p/95f12f72f69a" target="_blank" rel="external">《javapoet——让你从重复无聊的代码中解放出来》</a> 。</li>
</ol>
<h6 id="findAndParseTargets-env"><a href="#findAndParseTargets-env" class="headerlink" title="findAndParseTargets(env)"></a>findAndParseTargets(env)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 扫描所有的ButterKnife注解，并且生成以TypeElement为键，BindingSet为值的HashMap</span></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">	Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">	Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">	</div><div class="line">	scanForRClasses(env);</div><div class="line">	</div><div class="line">	<span class="comment">// 省略一堆解析各种注解的源码，这些源码做的事情和下面这个 for 循环一样</span></div><div class="line">	<span class="comment">// 所以只要看这个解析 @BindView 就够了</span></div><div class="line">	... </div><div class="line">	</div><div class="line">	<span class="comment">// Process each @BindView element.</span></div><div class="line">	<span class="comment">// 遍历所有被 @BindView 标注的元素</span></div><div class="line">	<span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">	  <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></div><div class="line">	  <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></div><div class="line">	  <span class="keyword">try</span> &#123;</div><div class="line">	    parseBindView(element, builderMap, erasedTargetNames);</div><div class="line">	  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">	    logParsingError(element, BindView.class, e);</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	... </div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先来看关于 <code>BindView</code> 的那个 for 循环，它会遍历所有被 <code>@BindView</code> 注解的属性，然后调用 <code>parseBindView</code>方法。</p>
<h6 id="parseBindView"><a href="#parseBindView" class="headerlink" title="parseBindView"></a>parseBindView</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; 		     builderMap,Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</div><div class="line">    <span class="comment">// 得到注解 @BindView 元素所在的类元素</span></div><div class="line">    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">    <span class="comment">// Start by verifying common generated code restrictions.</span></div><div class="line">    <span class="comment">// ---------- 类型校验逻辑 start ---------------</span></div><div class="line">    <span class="comment">// 判断是否被注解在属性上，如果该属性是被 private 或者 static 修饰的，则出错</span></div><div class="line">    <span class="comment">// 判断是否被注解在错误的包中，若包名以“android”或者“java”开头，则出错</span></div><div class="line">    <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">        || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">    <span class="comment">// Verify that the target type extends from View.</span></div><div class="line">    TypeMirror elementType = element.asType();</div><div class="line">    <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">      TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">      elementType = typeVariable.getUpperBound();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 判断元素是不是View及其子类或者Interface</span></div><div class="line">    <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">      <span class="keyword">if</span> (elementType.getKind() == TypeKind.ERROR) &#123;</div><div class="line">        note(element, <span class="string">"@%s field with unresolved type (%s) "</span></div><div class="line">                + <span class="string">"must elsewhere be generated as a View or interface. (%s.%s)"</span>,</div><div class="line">            BindView.class.getSimpleName(), elementType, enclosingElement.getQualifiedName(),</div><div class="line">            element.getSimpleName());</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>,</div><div class="line">            BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</div><div class="line">            element.getSimpleName());</div><div class="line">        hasError = <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果有错误 不执行下面代码</span></div><div class="line">    <span class="keyword">if</span> (hasError) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//---------------- 类型校验逻辑 end -----------------</span></div><div class="line"></div><div class="line">    <span class="comment">// Assemble information on the field.  //得到被注解的注解值，即 R.id.xxx</span></div><div class="line">    <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();</div><div class="line">    <span class="comment">// 根据所在的类元素去查找 builder</span></div><div class="line">    BindingSet.Builder builder = builderMap.get(enclosingElement);</div><div class="line">    <span class="comment">// 如果相应的 builder 已经存在</span></div><div class="line">    <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 得到相对应的 View 绑定的属性名</span></div><div class="line">      String existingBindingName = builder.findExistingBindingName(getId(id));</div><div class="line">      <span class="comment">// 若该属性名已经存在，则说明之前已经绑定过，会报错</span></div><div class="line">      <span class="keyword">if</span> (existingBindingName != <span class="keyword">null</span>) &#123;</div><div class="line">        error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">            BindView.class.getSimpleName(), id, existingBindingName,</div><div class="line">            enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 如果没有对应的 builder ，就通过 getOrCreateBindingBuilder 方法生成，并且放入 builderMap 中</span></div><div class="line">      builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 得到注解名</span></div><div class="line">    String name = element.getSimpleName().toString();</div><div class="line">    <span class="comment">// 得到注解元素的类型</span></div><div class="line">    TypeName type = TypeName.get(elementType);</div><div class="line">    <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line">    <span class="comment">// 根据 id ，添加相对应的 Field 的绑定信息</span></div><div class="line">    builder.addField(getId(id), <span class="keyword">new</span> FieldViewBinding(name, type, required));</div><div class="line"></div><div class="line">    <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">    <span class="comment">// 添加到待 unbind 的序列中</span></div><div class="line">    erasedTargetNames.add(enclosingElement);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>parseBindView</code> 方法中基本上都加了注释，在方法的开头会对该 <code>element</code> 去做校验。如果校验没通过的话，就没有下面代码的什么事了。若校验通过之后，生成该 <code>element</code> 所在的类元素对应的 builder ，builder 中添加相应的 Field 绑定信息，最后添加到待 unbind 的序列中去。</p>
<p>现在，我们回过头来看看 <code>findAndParseTargets(env)</code> 方法的后半段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line"></div><div class="line">	... <span class="comment">// 省略前半部分源码</span></div><div class="line"></div><div class="line">	<span class="comment">// Associate superclass binders with their subclass binders. This is a queue-based tree walk</span></div><div class="line">	<span class="comment">// which starts at the roots (superclasses) and walks to the leafs (subclasses).</span></div><div class="line">	Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</div><div class="line">	    <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</div><div class="line">	Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">	<span class="keyword">while</span> (!entries.isEmpty()) &#123;</div><div class="line">	  <span class="comment">// 一个个取出遍历</span></div><div class="line">	  Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</div><div class="line">	  <span class="comment">// 得到对应的 key 和 value</span></div><div class="line">	  TypeElement type = entry.getKey();</div><div class="line">	  BindingSet.Builder builder = entry.getValue();</div><div class="line">	  <span class="comment">// 找到该类元素的父元素</span></div><div class="line">	  TypeElement parentType = findParentType(type, erasedTargetNames);</div><div class="line">	  <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;</div><div class="line">	    <span class="comment">// 生成 BindingSet ，放入 Map 中</span></div><div class="line">	    bindingMap.put(type, builder.build());</div><div class="line">	  &#125; <span class="keyword">else</span> &#123;</div><div class="line">	    BindingSet parentBinding = bindingMap.get(parentType);</div><div class="line">	    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">	      <span class="comment">// 设置父元素的 BindingSet</span></div><div class="line">	      builder.setParent(parentBinding);</div><div class="line">	      bindingMap.put(type, builder.build());</div><div class="line">	    &#125; <span class="keyword">else</span> &#123;</div><div class="line">	      <span class="comment">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span></div><div class="line">	      <span class="comment">// 有父元素，但是父元素的 BindingSet 还没有被 build 出来，</span></div><div class="line">	      <span class="comment">// 所以再放入 entries 中等待遍历 </span></div><div class="line">	      entries.addLast(entry);</div><div class="line">	    &#125;</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 解析结果都会存放在 bindingMap 中</span></div><div class="line">	<span class="keyword">return</span> bindingMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要就是把之前的 <code>builderMap</code> 转换为了 <code>bindingMap</code> 并返回。到了这里，我们把 <code>process(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</code> 做的第一件事情搞清楚了，下面就接着来看第二件事情了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 遍历 bindingMap 并且通过 Filer 生成 Java 代码</span></div><div class="line"><span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">  TypeElement typeElement = entry.getKey();</div><div class="line">  BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">  JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    javaFile.writeTo(filer);</div><div class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="brewJava-int-sdk-和-createType-int-sdk"><a href="#brewJava-int-sdk-和-createType-int-sdk" class="headerlink" title="brewJava(int sdk) 和 createType(int sdk)"></a>brewJava(int sdk) 和 createType(int sdk)</h5><p>从上面可以看到，遍历了之前得到的 <code>bindingMap</code> ，然后利用 <code>binding</code> 中的信息生成相应的 Java 源码。所以在 <code>binding.brewJava(sdk)</code> 这个方法是我们重点关注对象。那么就进入 <code>BindingSet</code> 中去看看吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">JavaFile brewJava(int sdk) &#123;</div><div class="line">    // 生成 JavaFile，添加相应的注释</div><div class="line">    return JavaFile.builder(bindingClassName.packageName(), createType(sdk))</div><div class="line">            .addFileComment(&quot;Generated code from Butter Knife. Do not modify!&quot;)</div><div class="line">            .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是利用了 <code>JavaFile.builder</code> 生成了一个 <code>JavaFile</code> 对象。但是我们发现其中有一个 <code>createType(int sdk)</code> 方法，继续跟进去看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createType</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    <span class="comment">// 生成类名为 bindingClassName 的公共类，比如 MainActivity_ViewBinding</span></div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</div><div class="line">            .addModifiers(PUBLIC);</div><div class="line">    <span class="comment">// 是否修饰为 final ，默认是 false</span></div><div class="line">    <span class="keyword">if</span> (isFinal) &#123;</div><div class="line">        result.addModifiers(FINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果有父类的话，那么要继承父类</span></div><div class="line">        result.superclass(parentBinding.bindingClassName);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果没有父类，那么实现 Unbinder 接口</span></div><div class="line">        result.addSuperinterface(UNBINDER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 增加一个变量名为target，类型为targetTypeName的成员变量</span></div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">        result.addField(targetTypeName, <span class="string">"target"</span>, PRIVATE);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果没有 View 绑定</span></div><div class="line">    <span class="keyword">if</span> (!constructorNeedsView()) &#123;</div><div class="line">        <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></div><div class="line">        <span class="comment">// 该生成的构造方法被 @deprecated ，一般作为反射使用</span></div><div class="line">        result.addMethod(createBindingViewDelegateConstructor(targetTypeName));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成构造方法，另外 findViewById 类似的代码都在这里生成</span></div><div class="line">    <span class="comment">// Xxxx_ViewBinding 一般都是执行这个方法生成构造器</span></div><div class="line">    result.addMethod(createBindingConstructor(targetTypeName, sdk));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasViewBindings() || parentBinding == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//生成unBind方法</span></div><div class="line">        result.addMethod(createBindingUnbindMethod(result, targetTypeName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>createType(int sdk)</code> 方法中，基本构建好了一个类的大概，其中对于构造器以及类似 <code>findViewById</code> 的操作都是在 <code>createBindingConstructor(targetTypeName, sdk)</code> 中实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructor</span><span class="params">(TypeName targetType, <span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    <span class="comment">// 创建构造方法，方法修饰符为 public ，并且添加注解为UiThread</span></div><div class="line">    MethodSpec.Builder constructor = MethodSpec.constructorBuilder()</div><div class="line">            .addAnnotation(UI_THREAD)</div><div class="line">            .addModifiers(PUBLIC);</div><div class="line">    <span class="comment">// 如果有方法绑定，比如 @OnClick</span></div><div class="line">    <span class="keyword">if</span> (hasMethodBindings()) &#123;</div><div class="line">        <span class="comment">// 如果有，那么添加 targetType 类型，final 修饰，参数名为 target 的构造方法参数</span></div><div class="line">        constructor.addParameter(targetType, <span class="string">"target"</span>, FINAL);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果没有，和上面比起来就少了一个 final 修饰符</span></div><div class="line">        constructor.addParameter(targetType, <span class="string">"target"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果有注解的 View</span></div><div class="line">    <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">        <span class="comment">// 那么添加 View source 参数</span></div><div class="line">        constructor.addParameter(VIEW, <span class="string">"source"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 否则添加 Context context 参数</span></div><div class="line">        constructor.addParameter(CONTEXT, <span class="string">"context"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasUnqualifiedResourceBindings()) &#123;</div><div class="line">        <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></div><div class="line">        constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</div><div class="line">                .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ResourceType"</span>)</div><div class="line">                .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果有父类，那么会根据不同情况调用不同的 super 语句</span></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (parentBinding.constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"super(target, source)"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"super(target, source.getContext())"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            constructor.addStatement(<span class="string">"super(target, context)"</span>);</div><div class="line">        &#125;</div><div class="line">        constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果有绑定 Field 或者方法，那么添加 this.target = target 语句</span></div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"this.target = target"</span>);</div><div class="line">        constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果有 View 绑定</span></div><div class="line">    <span class="keyword">if</span> (hasViewBindings()) &#123;</div><div class="line">        <span class="keyword">if</span> (hasViewLocal()) &#123;</div><div class="line">            <span class="comment">// Local variable in which all views will be temporarily stored.</span></div><div class="line">            constructor.addStatement(<span class="string">"$T view"</span>, VIEW);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">            <span class="comment">// 为 View 绑定生成类似于 findViewById 之类的代码</span></div><div class="line">            addViewBinding(constructor, binding);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 为 View 的集合或者数组绑定</span></div><div class="line">        <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"$L"</span>, binding.render());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">            constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 绑定 resource 资源的代码</span></div><div class="line">    <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">        <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"$T context = source.getContext()"</span>, CONTEXT);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (hasResourceBindingsNeedingResource(sdk)) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"$T res = context.getResources()"</span>, RESOURCES);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</div><div class="line">            constructor.addStatement(<span class="string">"$L"</span>, binding.render(sdk));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> constructor.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的代码就生成了构造器， <code>findViewById</code> 都在 <code>addViewBinding(constructor, binding)</code> 里会看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addViewBinding</span><span class="params">(MethodSpec.Builder result, ViewBinding binding)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (binding.isSingleFieldBinding()) &#123;</div><div class="line">        <span class="comment">// Optimize the common case where there's a single binding directly to a field.</span></div><div class="line">        FieldViewBinding fieldBinding = binding.getFieldBinding();</div><div class="line">        <span class="comment">// 注意这里直接使用了 target. 的形式，所以属性肯定是不能 private 的</span></div><div class="line">        CodeBlock.Builder builder = CodeBlock.builder()</div><div class="line">                .add(<span class="string">"target.$L = "</span>, fieldBinding.getName());</div><div class="line">        <span class="comment">// 下面都是 View 绑定的代码</span></div><div class="line">        <span class="keyword">boolean</span> requiresCast = requiresCast(fieldBinding.getType());</div><div class="line">        <span class="keyword">if</span> (!requiresCast &amp;&amp; !fieldBinding.isRequired()) &#123;</div><div class="line">            builder.add(<span class="string">"source.findViewById($L)"</span>, binding.getId().code);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            builder.add(<span class="string">"$T.find"</span>, UTILS);</div><div class="line">            builder.add(fieldBinding.isRequired() ? <span class="string">"RequiredView"</span> : <span class="string">"OptionalView"</span>);</div><div class="line">            <span class="keyword">if</span> (requiresCast) &#123;</div><div class="line">                builder.add(<span class="string">"AsType"</span>);</div><div class="line">            &#125;</div><div class="line">            builder.add(<span class="string">"(source, $L"</span>, binding.getId().code);</div><div class="line">            <span class="keyword">if</span> (fieldBinding.isRequired() || requiresCast) &#123;</div><div class="line">                builder.add(<span class="string">", $S"</span>, asHumanDescription(singletonList(fieldBinding)));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (requiresCast) &#123;</div><div class="line">                builder.add(<span class="string">", $T.class"</span>, fieldBinding.getRawType());</div><div class="line">            &#125;</div><div class="line">            builder.add(<span class="string">")"</span>);</div><div class="line">        &#125;</div><div class="line">        result.addStatement(<span class="string">"$L"</span>, builder.build());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;MemberViewBinding&gt; requiredBindings = binding.getRequiredBindings();</div><div class="line">    <span class="keyword">if</span> (requiredBindings.isEmpty()) &#123;</div><div class="line">        result.addStatement(<span class="string">"view = source.findViewById($L)"</span>, binding.getId().code);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!binding.isBoundToRoot()) &#123;</div><div class="line">        result.addStatement(<span class="string">"view = $T.findRequiredView(source, $L, $S)"</span>, UTILS,</div><div class="line">                binding.getId().code, asHumanDescription(requiredBindings));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    addFieldBinding(result, binding);</div><div class="line">    <span class="comment">// OnClick 等监听事件绑定</span></div><div class="line">    addMethodBindings(result, binding);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，整个 <code>ButterKnifeProcessor</code> 解析注解、生成 Java 代码的流程就走完了。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>借鉴了很多大神的文章，非常感谢，也推荐给大家。</p>
<p><a href="http://yuqirong.me/2016/12/18/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" target="_blank" rel="external">ButterKnife源码分析</a></p>
<p><a href="https://www.race604.com/annotation-processing/" target="_blank" rel="external">Java注解处理器</a></p>
<p><a href="http://blog.csdn.net/industriously/article/details/53932425" target="_blank" rel="external">Android中使用AbstractProcessor在编译时生成代码</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      张昊
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://zhanghao.studio/开源项目——ButterKnife.html" title="开源项目——ButterKnife">http://zhanghao.studio/开源项目——ButterKnife.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/那些年，那些牛B的开源项目/" rel="tag"># 那些年，那些牛B的开源项目</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/对build-gradle中三个xxxVersion的理解.html" rel="next" title="对build.gradle中三个xxxVersion的理解">
                <i class="fa fa-chevron-left"></i> 对build.gradle中三个xxxVersion的理解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1487524748815&di=cd0f9aa211a9dd59ef60da71ac98b364&imgtype=0&src=http%3A%2F%2Fp8.qhimg.com%2Ft01b3499a7704e3ea91.jpg"
               alt="张昊" />
          <p class="site-author-name" itemprop="name">张昊</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gtzh110" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正文"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概要"><span class="nav-number">2.1.</span> <span class="nav-text">概要</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码跟踪"><span class="nav-number">2.2.</span> <span class="nav-text">源码跟踪</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#APT-和-ButterKnifeProcessor"><span class="nav-number">2.3.</span> <span class="nav-text">APT 和 ButterKnifeProcessor</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init-ProcessingEnvironment-env"><span class="nav-number">2.3.1.</span> <span class="nav-text">init(ProcessingEnvironment env)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getSupportedAnnotationTypes"><span class="nav-number">2.3.2.</span> <span class="nav-text">getSupportedAnnotationTypes()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#process-Set-lt-extends-TypeElement-gt-elements-RoundEnvironment-env"><span class="nav-number">2.3.3.</span> <span class="nav-text">process(Set<? extends TypeElement> elements, RoundEnvironment env)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#findAndParseTargets-env"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">findAndParseTargets(env)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#parseBindView"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">parseBindView</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#brewJava-int-sdk-和-createType-int-sdk"><span class="nav-number">2.3.4.</span> <span class="nav-text">brewJava(int sdk) 和 createType(int sdk)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结语"><span class="nav-number">3.</span> <span class="nav-text">结语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张昊</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  Hosted by 
  <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>

  
  <script type="text/javascript" src="/vendors/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

</body>
</html>
